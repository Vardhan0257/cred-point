{% extends 'base.html' %}
{% block title %}Login - CredPoint{% endblock %}

{% block content %}

<div class="login-wrapper">

<div class="login-card">

<div class="login-header">
<h2>Sign in to CredPoint</h2>
<p>Manage certifications and track your CPE progress</p>
</div>

<form id="firebase-login-form" data-no-mainjs="true">

<div id="login-error" class="alert alert-danger d-none"></div>

<div class="mb-3">
<label class="form-label">Email</label>
<input type="email" id="email" class="form-control" required>
</div>

<div class="mb-4">
<label class="form-label">Password</label>
<input type="password" id="password" class="form-control" required>
</div>

<button id="login-btn" type="submit" class="btn btn-primary w-100">
Sign In
</button>

</form>

<div class="login-footer">
<span>New here?</span>
<a href="{{ url_for('routes.register_page') }}">Create account</a>
</div>

</div>
</div>

<style>
.login-wrapper{
min-height:80vh;
display:flex;
align-items:center;
justify-content:center;
}

.login-card{
width:100%;
max-width:420px;
background:#11161c;
border:1px solid #1f242c;
border-radius:16px;
padding:40px;
box-shadow:0 20px 60px rgba(0,0,0,0.4);
}

.login-header{
text-align:center;
margin-bottom:28px;
}

.login-header h2{
font-weight:700;
margin-bottom:6px;
}

.login-header p{
color:#9aa3b2;
font-size:14px;
}

.login-footer{
margin-top:24px;
text-align:center;
color:#9aa3b2;
font-size:14px;
}

.login-footer a{
color:#fff;
text-decoration:none;
margin-left:6px;
}
</style>

{% endblock %}
{% block scripts %}

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
window.addEventListener("load", function () {

    console.log("Login script active");

    const firebaseConfig = {
        apiKey: "{{ firebase_config.apiKey }}",
        authDomain: "{{ firebase_config.authDomain }}",
        projectId: "{{ firebase_config.projectId }}"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }

    const form = document.getElementById('firebase-login-form');

    if (!form) {
        console.error("Form not found");
        return;
    }

    form.addEventListener('submit', async function (e) {
        e.preventDefault();

        console.log("Submitting login...");

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            const userCredential =
                await firebase.auth().signInWithEmailAndPassword(email, password);

            const token = await userCredential.user.getIdToken();

            const response = await fetch('/session-login', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({ idToken: token })
            });

            if(response.ok){
                window.location.href='/dashboard';
            } else {
                showError("Session login failed");
            }

        } catch(err){
            console.error(err);
            showError(err.message);
        }
    });

    function showError(msg){
        const el=document.getElementById('login-error');
        el.textContent=msg;
        el.classList.remove('d-none');
    }

});
</script>

{% endblock %}
