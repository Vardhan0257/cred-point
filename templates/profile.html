{% extends 'base.html' %}
{% block title %}Profile - CPE Management Platform{% endblock %}
{% block content %}
<div class="container py-5">
    <h1 class="mb-4"><i class="fas fa-user me-2 text-secondary"></i>Profile</h1>

    <div class="card shadow-sm border-0">
        <div class="card-body text-start">
            <!-- Profile Picture -->
            <img id="profilePic" 
                 src="{{ user_data.profile_image or 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRtRs_rWILOMx5-v3aXwJu7LWUhnPceiKvvDg&s' }}"
                 class="rounded-circle mb-3"
                 width="120" height="120" alt="Profile Picture">

            <h4>{{ user_data.full_name or 'Not set' }}</h4>
            <p class="text-muted">{{ user_data.email or 'Not available' }}</p>

            <p>
                <strong>Status:</strong>
                {% if user_data.email_verified %}
                    <span class="badge bg-success">Verified</span>
                {% else %}
                    <span class="badge bg-danger">Not Verified</span>
                {% endif %}
            </p>

            {% if user_data.created_at %}
                <p><strong>Joined:</strong> {{ user_data.created_at }}</p>
            {% endif %}
            {% if user_data.updated_at %}
                <p><strong>Last Updated:</strong> {{ user_data.updated_at }}</p>
            {% endif %}

            <hr>

            <!-- Update button -->
            <button id="editBtn" class="btn btn-primary" type="button">
                <i class="fas fa-edit me-1"></i> Update Profile
            </button>

            <!-- Edit form -->
            <form id="editForm" method="POST" action="{{ url_for('routes.profile_page') }}" 
                  enctype="multipart/form-data" style="display:none;" class="mt-3">
                {{ form.hidden_tag() }}
                <div class="mb-3">
                    {{ form.full_name.label(class="form-label") }}
                    {{ form.full_name(class="form-control", value=user_data.full_name or "") }}
                </div>
                
                <!-- Upload Profile Image Button -->
                <div class="mb-3">
                    <label class="form-label">Upload Profile Picture</label><br>
                    <button type="button" class="btn btn-secondary mb-2" onclick="document.getElementById('uploadInput').click()">
                        <i class="fas fa-upload me-1"></i> Upload Image
                    </button>
                    {{ form.profile_image(class="form-control d-none", id="uploadInput", accept="image/*") }}
                </div>

                <!-- Save and Cancel buttons -->
                <div class="d-flex gap-2">
                    {{ form.submit(class="btn btn-success") }}
                    <button type="button" class="btn btn-outline-secondary" id="cancelBtn">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('editBtn').addEventListener('click', function() {
    const form = document.getElementById('editForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
});

document.getElementById('cancelBtn').addEventListener('click', function() {
    document.getElementById('editForm').style.display = 'none';
});

// Preview uploaded image instantly
document.getElementById('uploadInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
            document.getElementById('profilePic').src = evt.target.result;
        };
        reader.readAsDataURL(file);
    }
});
</script>
{% endblock %}
